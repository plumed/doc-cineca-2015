<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>PLUMED: Installation Layout</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed-code.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../user-doc/html/index.html"> <img src="developer-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Installation Layout </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>I write here some notes related to how plumed is installed.</p>
<p>As a first notice, plumed package is mostly designed to make available these tools:</p><ul>
<li>a <code>plumed</code> executable, that can be used to launch command line tools.</li>
<li>a <code>libplumed.so</code> library, that can be linked to an externally supplied MD code.</li>
</ul>
<p>These are the main entry points to plumed, but they require several other resources to be properly located so as to work. Moreover, plumed is designed to be usable both when "just compiled" (so as to allow for fast development) and when properly installed. This result in the non trivial problem of knowing where the required resources are located.</p>
<p>Additionally, we provide shell-only alternatives to command line tools. E.g., to use <code>plumed patch</code> in a cross compiled environment, one can call <code>plumed-patch</code> which does the same but bypass the <code>plumed</code> executable and directly executes as a bash script.</p>
<p>As a result, plumed routines and scripts can be entered in three ways:</p><ul>
<li>calling <code>plumed</code> from the command line.</li>
<li>calling <code>plumed-patch</code> from the command line.</li>
<li>entering the shared library from another code (typically an MD code).</li>
</ul>
<p>This is achieved in the following way:</p><ul>
<li><code>plumed-*</code> scripts set appropriate environment variables pointing at the correct paths when they are launched.</li>
<li><code>plumed</code> executable and <code>libplumed.so</code> have access to methods (in the config namespace) to access to the paths and locate resources.</li>
</ul>
<p>As an example, the $PLUMED_ROOT variable is defined to tell to the plumed scripts where to find most of the plumed-related files. Similarly, from C++ you can use <a class="el" href="namespace_p_l_m_d_1_1config.html#ac912fda233a0fc65f8ffa814b9af13b1">config::getPlumedRoot()</a> to get the same path.</p>
<p>When a plumed command line tool implemented as script is invoked by the plumed executable, thus transfering the control from C++ to an external script, the environment is consistently set. This is done in method <a class="el" href="namespace_p_l_m_d_1_1config.html#a85049ba946c77d09993e858d046d198a">config::getEnvCommand()</a> which builds a string in the form "env PLUMED_ROOT=/path env PLUMED_INCLUDEDIR=/path " etc.</p>
<p>The following paths need to be set for plumed to work properly. Here they are listed together with the name of the corresponding environment variable (that can be used in plumed scrits) and the method that can be used to retrieve them from C++ code.</p><ul>
<li>Root of plumed: PLUMED_ROOT <a class="el" href="namespace_p_l_m_d_1_1config.html#ac912fda233a0fc65f8ffa814b9af13b1">config::getPlumedRoot()</a></li>
<li>Path to include files: PLUMED_INCLUDEDIR <a class="el" href="namespace_p_l_m_d_1_1config.html#a66757361f249fd1a951ff1ff067d3ae7">config::getPlumedIncludedir()</a></li>
<li>Path to html files: PLUMED_HTMLDIR <a class="el" href="namespace_p_l_m_d_1_1config.html#aac17119d37fbb1d6b992d34f6c2f19f3">config::getPlumedHtmldir()</a></li>
<li>Name of plumed program: PLUMED_PROGRAM_NAME <a class="el" href="namespace_p_l_m_d_1_1config.html#a6e5fb918a02168340970553d086131f6">config::getPlumedProgramName()</a></li>
</ul>
<p>When using plumed from its build directory (without installing) these paths will be set to the value reported below:</p><ul>
<li>Root of plumed: /build/directory</li>
<li>Path to include files: /build/directory/include (this works thanks to a symlink of /build/directory/src to /build/directory/include/plumed)</li>
<li>Path to html files: /build/directory</li>
<li>Name of plumed program: plumed</li>
</ul>
<p>These paths are hardcoded in <code>plumed</code> executable and in <code>plumed-*</code> scripts when they are compiled. Notice that it is possible to set the PLUMED_ROOT variable before calling plumed overriding the hard code values. E.g., you can compile plumed in directory <code>/build/directory1</code>, move it to <code>/build/directory2</code>, and launch it with <code>PLUMED_ROOT /build/directory2/src/lib/plumed</code>. Notice however that although plumed will find all the required resources in this way, it won't be possible to perform some task such as patching MD code.</p>
<p>When using plumed after installed, these paths will be set to the value reported below:</p><ul>
<li>Root of plumed: /usr/local/lib/plumed</li>
<li>Path to include files: /usr/local/include</li>
<li>Path to html files: /usr/local/share/doc/plumed</li>
<li>Name of plumed program: plumed</li>
</ul>
<p>These paths are hardcoded in <code>plumed</code> executable and in <code>plumed-*</code> scripts when they are installed. Notice that these value can be customized at configure step using standard arguments to ./configure. When using an installed copy of plumed one can override the hard code values by setting the variables PLUMED_ROOT PLUMED_INCLUDEDIR PLUMED_HTMLDIR and PLUMED_PROGRAM_NAME before launching plumed.</p>
<p>Notice that to enforce a consistent behavior of scripts and plumed executable the same logic needed to be implemented twice. One implementation is found in the <a class="el" href="_config_8cpp.html">src/config/Config.cpp</a> file, another implementation is prependend to the installed scripts by the src/config/Makefile.</p>
<p>Also consider that environment is inherited by subprocesses. That means that if you want to launch another plumed version from a plumed script (crazy idea, perhaps nobody will ever do it) you should unexport the relevant environemnt variable to that the second plumed executable will find its paths correctly.</p>
<h1><a class="anchor" id="InstallationLayout-files"></a>
Installed files</h1>
<p>I here describe what's the content of the most important files installed by plumed.</p>
<p><code>/usr/local/bin/plumed</code>: this is a static executable that can be used to launch plumed. It is typically used to launch a command line tool (e.g. <code>plumed sum_hills</code>). Notice that some command line tools are actually implemented as bash scripts (e.g. <code>plumed patch</code>). Those scripts are located in $PLUMED_ROOT/scripts/ with an extra <code>.sh</code> suffix. E.g. the <code>plumed patch</code> will set properly the environment then call <code>$PLUMED_ROOT/scripts/patch.sh</code>.</p>
<p><code>/usr/local/lib/libplumed.so</code>: this is a library containing all the plumed routines. Notice that <code>/usr/local/bin/plumed</code> described above is equal to the combination of <code>/usr/local/lib/libplumed.so</code> with a single object file compiled from <code>buildroot/src/main/main.cpp</code>.</p>
<p><code>/usr/local/lib/libplumedKernel.so</code>: this is a library containing almost all the plumed routines, with the exception of those called from MD engines. Notice that <code>/usr/local/lib/libplumedKernel.so</code> described above is equal to the combination of <code>/usr/local/lib/libplumedKernel.so</code> with a single object file compiled from <code>buildroot/src/wrapper/PlumedStatic.cpp</code></p>
<p>The logic of this subdivision is that it is possible to either link the MD code to <code>/usr/local/lib/libplumed.so</code> or to link it to a single object file (the one compiled from <code>buildroot/src/wrapper/Plumed.cpp</code>) so as to allow linking at run time an a posteriori chosen plumed library. This is the trick behind the <code>--runtime</code> patching procedure.</p>
<p>Notice that the only difference between <code>buildroot/src/wrapper/PlumedStatic.cpp</code> and <code>buildroot/src/wrapper/Plumed.cpp</code> is that runtime binding is disabled for the first one.</p>
<p>We can then dissect more the content of <code>/usr/local/lib/libplumedKernel.so</code>. This library puts together a large list of object files. The same object files will be located after install in <code>/usr/local/lib/plumed/obj/k*.o</code>. I use a wildcard here because these might be many files (named <code>k0.o</code>, 'k1.o', etc) or a single <code>kernel.o</code> file (when <code>ld -r -o</code> can be used to merge them together). The reason why we store object files in the installed directory is that this is the most portable way to link statically C++ objects to another executable. Indeed, merging them in a single .a file (such as libplumed.a) would require this library to be linked with special flags so as to allow dropping all the static constructors. Whereas the special flags could be found by autoconf, it seems simpler to directly link <code>/usr/local/lib/plumed/obj/k*.o</code>.</p>
<p>Also notice that this library changes slighlty in the installed version (<code>/usr/local/lib/libplumedKernel.so</code>) and in the pre-install version (<code>buildroot/src/lib/libplumedKernel.so</code>). Indeed, whereas the former include the object file from <code>buildroot/src/config/ConfigInstall.cpp</code> the latter includes the object file from <code>buildroot/src/config/Config.cpp</code>. This object file is the one containing the hardcoded paths discussed above.</p>
<h1><a class="anchor" id="InstallationLayout-installation"></a>
Installation procedure</h1>
<p>When <code>make</code> is invoked, several things are performed. First, plumed is compiled. Then, the "to be installed" versions of the library files are produced and located in <code>buildroot/src/lib/install</code>. These are different from those located in <code>buildroot/src/lib</code> in that they include the <code>buildroot/src/config/ConfigInstall.o</code> object so has to hardcode the proper paths.</p>
<p>When <code>make install</code> is invoked, the makefile checks if the objects in <code>buildroot/src/lib/install</code> should be updated and, if necessary, recompiles them. If not, it just copy all the material in place. Notice that all the resulting files are real files (no symlinks). This is a novelty with respect to PLUMED 2.1.</p>
<p>Using the standard behavior explained in the autoconf documentation, it is possible to change the paths for plumed install either during configure (with <code>--prefix</code>) or by setting <code>prefix</code> during <code>make install</code>. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<table align="center" frame="void" width="98%" cellpadding="2%">
<tr><td align="left" valign="center"> 
Hosted by GitHub &nbsp;
<a href="http://github.com"><img src="octocat.png" width="88" height="66"  alt="GitHub Logo" /></a>
<!--Generated by  &#160; --> <a href="http://www.doxygen.org/index.html">
</td><td width=90% align="right">
<img class="footer" src="doxygen.png" alt="doxygen" align="right"/>
</a> 1.8.7
</td> </tr> 
</table>
</small></address>
</body>
</html>
