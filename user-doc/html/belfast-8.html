<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>PLUMED: Belfast tutorial: Replica exchange II and Multiple walkers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed-code.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.3.0-dev</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home&#160;(cineca-2015)</span></a></li>
      <li><a href="_syntax.html"><span>Getting&#160;started</span></a></li>
      <li><a href="tutorials.html"><span>Tutorials</span></a></li>
      <li><a href="glossary.html"><span>Index&#160;of&#160;Actions</span></a></li>
      <li><a href="cineca.html"><span>Cineca</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('belfast-8.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Belfast tutorial: Replica exchange II and Multiple walkers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="belfast-8-aim"></a>
Aims</h1>
<p>The aim of this tutorial is to introduce the users to the use of Bias-Exchange Metadynamics. We will go through the writing of the input files for BEMETA for a simple case of three peptide and we will use METAGUI to to analyse them. We will compare the results of WT-BEMETA and STANDARD-BEMETA with four independent runs on the four Collective Variables. Finally we will use a simplified version of BEMETA that is Multiple Walkers Metadynamics.</p>
<h2><a class="anchor" id="belfast-8-lo"></a>
Learning Outcomes</h2>
<p>Once this tutorial is completed students will:</p>
<ul>
<li>Know how to run a Bias-Exchange simulation using PLUMED and GROMACS</li>
<li>Know how to analyse the results of BEMETA with the help of METAGUI</li>
<li>Know how to run a Multiple Walker simulation</li>
</ul>
<h1><a class="anchor" id="belfast-8-res"></a>
Resources</h1>
<p>The <a href="tutorial-resources/belfast-8.tar.gz" download="belfast-8.tar.gz">tarball </a> for this project contains the following files:</p>
<ul>
<li>system folder: a starting structure for Val-Ile-Leu system</li>
<li>WTBX: a run of Well-Tempered Bias-Exchange Metadynamics ready for the analysis</li>
</ul>
<h1><a class="anchor" id="belfast-8-ins"></a>
Instructions</h1>
<h2><a class="anchor" id="belfast-8-bemeta"></a>
Bias-Exchange Metadynamics</h2>
<p>In all variants of metadynamics the free-energy landscape of the system is reconstructed by gradually filling the local minima with gaussian hills. The dimensionality of the landscape is equal to the number of CVs which are biased, and typically a number of CVs smaller than three is employed. The reason for this is that qualitatively, if the CVs are not correlated among them, the simulation time required to fill the free-energy landscape grows exponentially with the number of CVs. This limitation can be severe when studying complex transformations or reactions in which more than say three relevant CVs can be identified.</p>
<p>A possible technique to overcome this limitation is parallel-tempering metadynamics, <a class="el" href="belfast-7.html">Belfast tutorial: Replica exchange I</a>. A different solution is performing a bias-exchange simulation: in this approach a relatively large number N of CVs is chosen to describe the possible transformations of the system (e.g., to study the conformations of a peptide one may consider all the dihedral angles between amino acids). Then, N metadynamics simulations (replicas) are run on the same system at the same temperature, biasing a different CV in each replica.</p>
<p>Normally, in these conditions, each bias profile would converge very slowly to the equilibrium free-energy, due to hysteresis. Instead, in the bias-exchange approach every fixed number of steps (say 10,000) an exchange is attempted between a randomly selected pair of replicas \( a \) and \( b \). The probability to accept the exchange is given by a Metropolis rule:</p>
<p class="formulaDsp">
\[ \min\left( 1, \exp \left[ \beta ( V_G^a(x^a,t)+V_G^b(x^b,t)-V_G^a(x^b,t)-V_G^b(x^a,t) ) \right] \right) \]
</p>
<p>where \( x^{a} \) and \( x^{b} \) are the coordinates of replicas \(a \) and \( b \) and \( V_{G}^{a(b)}\left(x,t\right) \) is the metadynamics potential acting on the replica \( a \)( \( b \)). Each trajectory evolves through the high dimensional free energy landscape in the space of the CVs sequentially biased by different metadynamics potentials acting on one CV at each time. The results of the simulation are N one-dimensional projections of the free energy.</p>
<p>In the following example, a bias-exchange simulation is performed on a VIL peptide (zwitterionic form, in vacuum with \( \epsilon=80 \), force field amber03), using the four backbone dihedral angles as CVs.</p>
<p>Four replicas of the system are employed, each one biased on a different CV, thus four similar Plumed input files are prepared as follows:</p>
<ul>
<li>a common input file in which all the collective variables are defined:</li>
</ul>
<pre class="fragment">MOLINFO STRUCTURE=VIL.pdb
RANDOM_EXCHANGES

cv1: TORSION ATOMS=@psi-1
cv2: TORSION ATOMS=@phi-2
cv3: TORSION ATOMS=@psi-2
cv4: TORSION ATOMS=@phi-3
</pre><p>NOTE:</p><ol type="1">
<li>By using <a class="el" href="_m_o_l_i_n_f_o.html">MOLINFO</a> we can use shortcut to select atoms for dihedral angles (currently @phi, @psi, @omega and @chi1 are available).</li>
<li>We use cv# as labels in order to make the output compatible with METAGUI.</li>
<li><a class="el" href="_r_a_n_d_o_m__e_x_c_h_a_n_g_e_s.html">RANDOM_EXCHANGES</a> generates random exchanges list that are sent back to GROMACS.</li>
</ol>
<ul>
<li>four additional input files that <a class="el" href="_i_n_c_l_u_d_e.html">INCLUDE</a> the common input and define the four <a class="el" href="_m_e_t_a_d.html">METAD</a> along the four CVs, respectively.</li>
</ul>
<pre class="fragment">INCLUDE FILE=plumed-common.dat
be: METAD ARG=cv1 HEIGHT=0.2 SIGMA=0.2 PACE=100 GRID_MIN=-pi GRID_MAX=pi GRID_BIN=200 
PRINT ARG=cv1,cv2,cv3,cv4 STRIDE=1000 FILE=COLVAR
</pre><p>NOTE:</p><ol type="1">
<li>in COLVAR we <a class="el" href="_p_r_i_n_t.html">PRINT</a> only the four collective variables, always in the same order in such a way that COLVARs are compatible with METAGUI</li>
<li>if you want to print additional information, like the <a class="el" href="_m_e_t_a_d.html">METAD</a> bias it is possibile to use additional <a class="el" href="_p_r_i_n_t.html">PRINT</a> keyword</li>
</ol>
<pre class="fragment">PRINT ARG=cv1,be.bias STRIDE=xxx FILE=BIAS
</pre><p>The four replicas start from the same GROMACS topology file replicated four times: topol0.tpr, topol1.tpr, topol2.tpr, topol3.tpr. Finally, GROMACS is launched as a parallel run on 4 cores, with one replica per core, with the command</p>
<pre class="fragment">mpirun -np 4 mdrun_mpi -s topol -plumed plumed -multi 4 -replex 2000 &gt;&amp; log &amp;
</pre><p>where -replex 2000 indicates that every 2000 molecular-dynamics steps all replicas are randomly paired (e.g. 0-2 and 1-3) and exchanges are attempted between each pair (as printed in the GROMACS *.log files).</p>
<p>The same simulation can be run using WELLTEMPERED metadynamics.</p>
<h2><a class="anchor" id="belfast-8-bxcon"></a>
Convergence of the Simulations</h2>
<p>In the resources for this tutorial you can find the results for a 40ns long Well-Tempered Bias Exchange simulation. First of all we can try to assess the convergence of the simulations by looking at the profiles. In the "convergence" folder there is a script that calculates the free energy from the HILLS.0 file at incresing simulation lengths (i.e. every more 0.8 ns of simulation). The scripts also generate two measures of the evolution of the profiles in time:</p>
<ol type="1">
<li>time-diff.HILLS.0: where it is stored the average deviation between two successive profiles</li>
<li>KL.HILLS.0: where it is stored the average deviation between profiles correctly weigheted for the free energy of the profiles themselves (Symmetrized Kullback-Lieber divergence)</li>
</ol>
<p>From both plots one can deduce that after 8 ns the profiles don't change significantly thus suggesting that averaging over the range 8-40ns should result in a accurate profile (we will test this using metagui). Another test is that of looking at the fluctuations of the profiles in a time window instead of looking at successive profiles:</p>
<p><a class="anchor" id="belfast-8-convergence-fig"></a></p><div class="image">
<img src="belfast-8-convergence.png" alt="belfast-8-convergence.png"/>
<div class="caption">
Superposition of FE profiles in different time windows</div></div>
<h2><a class="anchor" id="belfast-8-metagui"></a>
Bias-Exchange Analysis with METAGUI</h2>
<p>In principle Bias-Exchange Metadynamics can give as a results only N 1D free energy profiles. But the information contained in all the replicas can be used to recover multidensional free energy surfaces in &gt;=N dimensions. A simple way to perform this analysis is to use METAGUI. METAGUI performs the following operations:</p>
<ol type="1">
<li>Clusterizes the trajectories on a multidimensional GRID defined by at least the biased coordinates.</li>
<li>By using the 1D free energy profiles and the clustering assigns a free energy to the cluster using a WHAM procedure.</li>
<li>Lets the user visualize the clusters.</li>
<li>Approximates the kinetics among clusters.</li>
</ol>
<p>METAGUI (Biarnes et. al) is a plugin for VMD that implements the approch developed by Marinelli et. al 2009. It can be downloaded from the PLUMED website.</p>
<p>In order for the colvar and hills file to be compatible with METAGUI their header must be formatted as following:</p>
<p>COLVAR.#: </p><pre class="fragment">#! FIELDS time cv1 cv2 cv3 cv4
#! ACTIVE 1 1 A
#! ..
...
</pre><p>NOTE:</p><ol type="1">
<li>the COLVAR.# files should contain ALL the collective variables employed (all those biased in at least one replica plus those additionaly analysed). They MUST be named cv1 ... cvN.</li>
<li>the COLVAR.# files must be synchronised with the trajectories, this means that for each frame in the trajectory at time t there must be a line in each colvar at time t and viceversa. The best option is usually to analyse the trajectories a posteriori using plumed driver.</li>
<li>a keyword #! ACTIVE NBIASEDCV BIASEDCV LABEL is needed, where NBIASEDCV is the number of biased cv in that replica (not overall), BIASEDCV is the index of the biased cv in that replica (i.e. 1 for the first replica and so on); LABEL is a letter that identify the replica (usually is simply A for the first, B for the second and so on) this is usufull if two replicas are biasing the same collective variable:</li>
</ol>
<pre class="fragment">COLVAR.0:
#! FIELDS time cv1 cv2 cv3
#! ACTIVE 1 1 A
#! ..
...
COLVAR.1:
#! FIELDS time cv1 cv2 cv3
#! ACTIVE 1 2 B
#! ..
...
COLVAR.2:
#! FIELDS time cv1 cv2 cv3
#! ACTIVE 1 2 C
#! ..
...
COLVAR.3:
#! FIELDS time cv1 cv2 cv3
#! ACTIVE 0 
#! ..
...</pre><p>In the above case Replica 0 biases cv1; replicas 1 and 2 biases cv2 while replica 3 is a neutral (unbiased) replica. cv3 is unbiased in all the replicas.</p>
<p>The ACTIVE keyword must be the FIRST LINE in the HILLS.# files:</p>
<p>HILLS.#: </p><pre class="fragment">#! ACTIVE 1 1 A
#! FIELDS time cv1 sigma_cv1 height biasf
#! ..
...
</pre><p>The above notes hold for the HILLS files as well. In the folder metagui the script check_for_metagui.sh checks if the header of your file is compatible with METAGUI, but remember that this is not enough! Synchronisation of COLVAR and trajectory files is also needed. HILLS files can be written with a different frequency but times must be consistent.</p>
<p>NOTE: It is important to copy HILLS files in the metagui folder.</p>
<pre class="fragment">./check_for_metagui.sh ../COLVAR.0
</pre><p>will tell you that the ACTIVE keyword is missing, you need to modify all the header BEFORE proceeding with the tutorial!!</p>
<p>In the metagui folder there is a metagui.input file:</p>
<pre class="fragment">WHAM_EXE        wham_bemeta.x
BASINS_EXE      kinetic_basins.x
KT 2.4900
HILLS_FILE   HILLS.0  
HILLS_FILE   HILLS.1  
HILLS_FILE   HILLS.2  
HILLS_FILE   HILLS.3  
GRO_FILE     VIL.pdb 
COLVAR_FILE COLVAR.0 ../traj0.xtc "psi-1"
COLVAR_FILE COLVAR.1 ../traj1.xtc "phi-2"
COLVAR_FILE COLVAR.2 ../traj2.xtc "psi-2"
COLVAR_FILE COLVAR.3 ../traj3.xtc "phi-3"
TRAJ_SKIP 10
CVGRID 1  -3.1415 3.1415 15 PERIODIC
CVGRID 2  -3.1415 3.1415 15 PERIODIC
CVGRID 3  -3.1415 3.1415 15 PERIODIC
CVGRID 4  -3.1415 3.1415 15 PERIODIC
ACTIVE 4 1 2 3 4  
T_CLUSTER 0.
T_FILL    8000.
DELTA 4
GCORR 1
TR_N_EXP 5
</pre><p>where are defined the temperature in energy units, the place where to find COLVAR, HILLS and trajectory files. A reference gro or pdb file is needed to load the trajectories. The definition of the ranges and the number of bins for the available collective variables.</p>
<p>Now let's start with the analysis:</p>
<ol type="1">
<li>run VMD and load metagui</li>
<li>in metagui load the metagui.input file <a class="el" href="belfast-8.html#belfast-8-mg1-fig">belfast-8-mg1-fig</a></li>
<li>In the left section of the interface "load all" the trajectories</li>
<li>Find the Microstates</li>
</ol>
<p>In order to visualise the microstate it is convenient to align all the structures using the VMD RMSD Trajectory tool that can be found in Extensions-&gt;Analysis.</p>
<p>One or more microstates can be visualised by selecting them and clicking show.</p>
<p>You can sort the microstates using the column name tabs, for example by clicking on size the microstates will be ordered from the larger to the smaller. If you look at the largest one it is possible to observe that by using the four selected collective variables the backbone conformation of the peptide is well defined while the sidechains can populate different rotameric states.</p>
<p>The equilibrium time in the analysis panel should be such that by averaging over the two halves of the remind of the simulation the profiles are the same (i.e the profile averaged between Teq and Teq+(Ttot-Teq)/2 should be the same of that averaged from Teq+(Ttot-Teq)/2 and Ttot). By clicking on COMPUTE FREE ENERGIES, the program will first generate the 1D free energy profiles from the HILLS files and then run the WHAM analysis on the microstates. Once the analysis is done it is possible to visually check the convergence of the 1D profiles one by one by clicking on the K bottons next to the HILLS.# files. The BLUE and the RED profiles are the two profiles just defined, while the GREEN is the average of the two. Now it is possible for example to sort the microstates as a function of the free energy and save them by dumping the structures for further analysis.</p>
<p><a class="anchor" id="belfast-8-mg1-fig"></a></p><div class="image">
<img src="belfast-8-mg1.png" alt="belfast-8-mg1.png"/>
<div class="caption">
METAGUI Interface after loading metagui.input file</div></div>
<p>If you look in the metagui folder you will see a lot of files, some of them can be very usefull:</p>
<p>metagui/MICROSTATES: is the content of the microstates list table metagui/WHAM_RUN/VG_HILLS.#: are the opposite of the free energies calculated from the hills files metagui/WHAM_RUN/*.gnp: are gnuplot input files to plot the VG_HILLS.# files (i.e. gnuplot -&gt; load "convergence..") metagui/WHAM_RUN/FES: is the result of the WHAM, for each cluster there is its free energy and the error estimate from WHAM</p>
<pre class="fragment">gnuplot&gt; plot [0:40]'FES' u 2:3
</pre><p>plots the microstate error in the free energy estimate as a function of the microstates free energy. Finally in the folder metagui/FES there is script to integrate the multidimensional free energy contained in the MICROSTATES files to a 2D FES as a function of two of the used CV. To use it is enough to copy the MICROSTATES file in FES:</p>
<pre class="fragment">cp MICROSTATES FES/FES.4D
</pre><p>and edit the script to select the two columns of MICROSTATES on which show the integrated FES.</p>
<h2><a class="anchor" id="belfast-8-mw"></a>
Multiple Walker Metadynamics</h2>
<p>Multiple Walker metadynamics is the simplest way to parallelise a MetaD calculation: multiple simulation of the same system are run in parallel using metadynamics on the same set of collective variables. The deposited bias is shared among the replicas in such a way that the history dependent potential depends on the whole history.</p>
<p>We can use the same common input file defined above and then we can define four metadynamics bias in a similar way of what was done above for bias-exchange but now all the biases are defined on the same collective variables:</p>
<pre class="fragment">plumed.dat.#
INCLUDE FILE=plumed-common.dat

METAD ...
LABEL=mw 
ARG=cv2,cv3 
SIGMA=0.3,0.3 
HEIGHT=0.2 
PACE=100
BIASFACTOR=8
TEMP=300 
GRID_MIN=-pi,-pi 
GRID_MAX=pi,pi 
GRID_BIN=200,200
WALKERS_MPI
... METAD

PRINT ARG=cv1,cv2,cv3,cv4 STRIDE=1000 FILE=COLVAR
</pre><p>and the simulation can be run in a similar way without doing exchanges:</p>
<pre class="fragment">mpirun -np 4 mdrun_mpi -s topol -plumed plumed -multi 4  &gt;&amp; log &amp;
</pre><p>alternatively Multiple Walkers can be run as independent simulations sharing via the file system the biasing potential, this is usefull because it provides a parallelisation that does not need a parallel code. In this case the walkers read with a given frequency the gaussians deposited by the others and add them to their own <a class="el" href="_m_e_t_a_d.html">METAD</a>.</p>
<h1><a class="anchor" id="belfast-8-refer"></a>
Reference</h1>
<p>This tutorial is freely inspired to the work of Biarnes et al.</p>
<p>More materials can be found in</p>
<ol type="1">
<li>Marinelli, F., Pietrucci, F., Laio, A. &amp; Piana, S. A kinetic model of trp-cage folding from multiple biased molecular dynamics simulations. PLoS Comput. Biol. 5, e1000452 (2009).</li>
<li>Biarnés, X., Pietrucci, F., Marinelli, F. &amp; Laio, A. METAGUI. A VMD interface for analyzing metadynamics and molecular dynamics simulations. Comput. Phys. Commun. 183, 203–211 (2012).</li>
<li>Baftizadeh, F., Cossio, P., Pietrucci, F. &amp; Laio, A. Protein folding and ligand-enzyme binding from bias-exchange metadynamics simulations. Current Physical Chemistry 2, 79–91 (2012).</li>
<li>Granata, D., Camilloni, C., Vendruscolo, M. &amp; Laio, A. Characterization of the free-energy landscapes of proteins by NMR-guided metadynamics. Proc. Natl. Acad. Sci. U.S.A. 110, 6817–6822 (2013).</li>
<li>Raiteri, P., Laio, A., Gervasio, F. L., Micheletti, C. &amp; Parrinello, M. Efficient reconstruction of complex free energy landscapes by multiple walkers metadynamics. J. Phys. Chem. B 110, 3533–3539 (2006). </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
